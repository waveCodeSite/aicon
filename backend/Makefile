# AICGå†…å®¹åˆ†å‘å¹³å° - åç«¯æœåŠ¡ Makefile
# æä¾›å¼€å‘ç¯å¢ƒçš„å¿«é€Ÿå¯åŠ¨å’Œå¸¸ç”¨å‘½ä»¤

.PHONY: help start migrate setup worker beat test lint clean format check install

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
GRAY := \033[90m
RESET := \033[0m

# é¡¹ç›®é…ç½®
PROJECT_NAME := aicg-platform-backend
PYTHON := python3
UV := uv
PORT := 8000
HOST := 0.0.0.0

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(BLUE)AICGå¹³å°åç«¯æœåŠ¡ - å¼€å‘å‘½ä»¤é›†åˆ$(RESET)"
	@echo ""
	@echo "$(GREEN)æ ¸å¿ƒå‘½ä»¤:$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-12s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | sort
	@echo ""
	@echo "$(GREEN)ç¤ºä¾‹:$(RESET)"
	@echo "  make setup     # åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ"
	@echo "  make start     # å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo "  make migrate   # è¿è¡Œæ•°æ®åº“è¿ç§»"

setup: ## åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ (å®‰è£…ä¾èµ– + æ•°æ®åº“è¿ç§»)
	@echo "$(BLUE)ğŸš€ åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ...$(RESET)"
	$(UV) sync
	@echo "$(GREEN)âœ… ä¾èµ–å®‰è£…å®Œæˆ$(RESET)"
	$(MAKE) migrate
	@echo "$(GREEN)ğŸ‰ å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ!$(RESET)"
	@echo ""
	@echo "$(YELLOW)ç°åœ¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡:$(RESET)"
	@echo "  make start"

start: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (çƒ­é‡è½½)
	@echo "$(BLUE)ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...$(RESET)"
	@echo "$(GREEN)ğŸ“ æœåŠ¡åœ°å€: http://$(HOST):$(PORT)$(RESET)"
	@echo "$(GREEN)ğŸ“– APIæ–‡æ¡£: http://$(HOST):$(PORT)/docs$(RESET)"
	@echo "$(YELLOW)âš ï¸  ç¡®ä¿å…ˆå¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡: cd .. && ./scripts/start.sh$(RESET)"
	@echo ""
	$(UV) run uvicorn src.main:app --reload --host $(HOST) --port $(PORT)

migrate: ## è¿è¡Œæ•°æ®åº“è¿ç§»
	@echo "$(BLUE)ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»...$(RESET)"
	$(UV) run alembic upgrade head
	@echo "$(GREEN)âœ… æ•°æ®åº“è¿ç§»å®Œæˆ$(RESET)"

migrate-create: ## åˆ›å»ºæ–°çš„æ•°æ®åº“è¿ç§» (ä½¿ç”¨: make migrate-create MSG="æè¿°")
	@if [ -z "$(MSG)" ]; then \
		echo "$(RED)âŒ è¯·æä¾›è¿ç§»æè¿°: make migrate-create MSG=\"æ·»åŠ ç”¨æˆ·è¡¨\"$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“ åˆ›å»ºæ•°æ®åº“è¿ç§»: $(MSG)$(RESET)"
	$(UV) run alembic revision --autogenerate -m "$(MSG)"
	@echo "$(GREEN)âœ… è¿ç§»æ–‡ä»¶åˆ›å»ºå®Œæˆ$(RESET)"

migrate-down: ## å›æ»šæœ€åä¸€æ¬¡æ•°æ®åº“è¿ç§»
	@echo "$(YELLOW)âš ï¸  å›æ»šæ•°æ®åº“è¿ç§»...$(RESET)"
	$(UV) run alembic downgrade -1
	@echo "$(GREEN)âœ… è¿ç§»å›æ»šå®Œæˆ$(RESET)"

worker: ## å¯åŠ¨Celery Worker
	@echo "$(BLUE)ğŸ”„ å¯åŠ¨Celery Worker...$(RESET)"
	$(UV) run celery -A src.workers.base worker --loglevel=info --concurrency=4

beat: ## å¯åŠ¨Celery Beat (å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨)
	@echo "$(BLUE)â° å¯åŠ¨Celery Beat...$(RESET)"
	$(UV) run celery -A src.workers.base beat --loglevel=info

dev: ## å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ (API + Worker + Beat)
	@echo "$(BLUE)ğŸš€ å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ...$(RESET)"
	@echo "$(YELLOW)éœ€è¦åœ¨å¤šä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:$(RESET)"
	@echo ""
	@echo "$(GREEN)ç»ˆç«¯1 - APIæœåŠ¡:$(RESET)"
	@echo "  make start"
	@echo ""
	@echo "$(GREEN)ç»ˆç«¯2 - Celery Worker:$(RESET)"
	@echo "  make worker"
	@echo ""
	@echo "$(GREEN)ç»ˆç«¯3 - Celery Beat:$(RESET)"
	@echo "  make beat"

test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "$(BLUE)ğŸ§ª è¿è¡Œæµ‹è¯•...$(RESET)"
	$(UV) run pytest --cov=src --cov-report=term-missing
	@echo "$(GREEN)âœ… æµ‹è¯•å®Œæˆ$(RESET)"

test-unit: ## è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "$(BLUE)ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...$(RESET)"
	$(UV) run pytest -m unit --cov=src --cov-report=term-missing

test-integration: ## è¿è¡Œé›†æˆæµ‹è¯•
	@echo "$(BLUE)ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•...$(RESET)"
	$(UV) run pytest -m integration --cov=src --cov-report=term-missing

test-fast: ## è¿è¡Œå¿«é€Ÿæµ‹è¯• (æ’é™¤æ…¢é€Ÿæµ‹è¯•)
	@echo "$(BLUE)ğŸƒ è¿è¡Œå¿«é€Ÿæµ‹è¯•...$(RESET)"
	$(UV) run pytest -m "not slow" --cov=src --cov-report=term-missing

lint: ## è¿è¡Œä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–
	@echo "$(BLUE)ğŸ” ä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–...$(RESET)"
	$(MAKE) format
	$(MAKE) check

format: ## æ ¼å¼åŒ–ä»£ç  (black + isort)
	@echo "$(BLUE)ğŸ“ æ ¼å¼åŒ–ä»£ç ...$(RESET)"
	$(UV) run black src/ tests/
	$(UV) run isort src/ tests/
	@echo "$(GREEN)âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ$(RESET)"

check: ## ä»£ç è´¨é‡æ£€æŸ¥ (flake8 + mypy)
	@echo "$(BLUE)ğŸ” ä»£ç è´¨é‡æ£€æŸ¥...$(RESET)"
	@echo "$(YELLOW)Flake8æ£€æŸ¥:$(RESET)"
	$(UV) run flake8 src/ tests/ || true
	@echo "$(YELLOW)MyPyæ£€æŸ¥:$(RESET)"
	$(UV) run mypy src/ || true
	@echo "$(GREEN)âœ… ä»£ç æ£€æŸ¥å®Œæˆ$(RESET)"

clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
	@echo "$(BLUE)ğŸ§¹ æ¸…ç†é¡¹ç›®...$(RESET)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .coverage coverage.xml
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(RESET)"

install: ## å®‰è£…å¼€å‘ä¾èµ–
	@echo "$(BLUE)ğŸ“¦ å®‰è£…å¼€å‘ä¾èµ–...$(RESET)"
	$(UV) sync --dev
	@echo "$(GREEN)âœ… ä¾èµ–å®‰è£…å®Œæˆ$(RESET)"

add: ## æ·»åŠ æ–°ä¾èµ– (ä½¿ç”¨: make add PACKAGE=fastapi)
	@if [ -z "$(PACKAGE)" ]; then \
		echo "$(RED)âŒ è¯·æä¾›åŒ…å: make add PACKAGE=fastapi$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“¦ æ·»åŠ ä¾èµ–: $(PACKAGE)$(RESET)"
	$(UV) add $(PACKAGE)

add-dev: ## æ·»åŠ å¼€å‘ä¾èµ– (ä½¿ç”¨: make add-dev PACKAGE=pytest)
	@if [ -z "$(PACKAGE)" ]; then \
		echo "$(RED)âŒ è¯·æä¾›åŒ…å: make add-dev PACKAGE=pytest$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“¦ æ·»åŠ å¼€å‘ä¾èµ–: $(PACKAGE)$(RESET)"
	$(UV) add --dev $(PACKAGE)

shell: ## å¯åŠ¨Python Shell (å¸¦é¡¹ç›®ç¯å¢ƒ)
	@echo "$(BLUE)ğŸ å¯åŠ¨Python Shell...$(RESET)"
	$(UV) run python

db-reset: ## é‡ç½®æ•°æ®åº“ (åˆ é™¤æ‰€æœ‰è¡¨å¹¶é‡æ–°è¿ç§»)
	@echo "$(RED)âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®!$(RESET)"
	@read -p "ç¡®è®¤ç»§ç»­? [y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(BLUE)ğŸ”„ é‡ç½®æ•°æ®åº“...$(RESET)"
	$(UV) run alembic downgrade base
	$(MAKE) migrate
	@echo "$(GREEN)âœ… æ•°æ®åº“é‡ç½®å®Œæˆ$(RESET)"

db-status: ## æŸ¥çœ‹æ•°æ®åº“è¿ç§»çŠ¶æ€
	@echo "$(BLUE)ğŸ“Š æ•°æ®åº“è¿ç§»çŠ¶æ€:$(RESET)"
	$(UV) run alembic current

logs: ## æŸ¥çœ‹åº”ç”¨æ—¥å¿— (å¦‚æœå¯ç”¨äº†æ—¥å¿—æ–‡ä»¶)
	@if [ -f "logs/app.log" ]; then \
		echo "$(BLUE)ğŸ“„ åº”ç”¨æ—¥å¿—:$(RESET)"; \
		tail -f logs/app.log; \
	else \
		echo "$(YELLOW)âš ï¸  æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç¡®ä¿LOG_FILEé…ç½®æ­£ç¡®$(RESET)"; \
	fi

health: ## æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
	@echo "$(BLUE)ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€...$(RESET)"
	@echo "$(GREEN)APIæœåŠ¡:$(RESET)"
	@curl -s http://$(HOST):$(PORT)/health | python3 -m json.tool 2>/dev/null || echo "$(RED)æœåŠ¡æœªè¿è¡Œ$(RESET)"
	@echo ""
	@echo "$(GREEN)æ•°æ®åº“è¿æ¥:$(RESET)"
	@curl -s http://$(HOST):$(PORT)/health/database | python3 -m json.tool 2>/dev/null || echo "$(RED)æ•°æ®åº“æ£€æŸ¥å¤±è´¥$(RESET)"

docs: ## å¯åŠ¨æ–‡æ¡£æœåŠ¡ (å¦‚æœé…ç½®äº†)
	@echo "$(BLUE)ğŸ“š APIæ–‡æ¡£åœ°å€:$(RESET)"
	@echo "$(GREEN)Swagger UI: http://$(HOST):$(PORT)/docs$(RESET)"
	@echo "$(GREEN)ReDoc: http://$(HOST):$(PORT)/redoc$(RESET)"

# å¼€å‘è€…å·¥å…·
info: ## æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "$(BLUE)ğŸ“‹ é¡¹ç›®ä¿¡æ¯:$(RESET)"
	@echo "  é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "  Pythonç‰ˆæœ¬: $(shell $(PYTHON) --version)"
	@echo "  uvç‰ˆæœ¬: $(shell $(UV) --version)"
	@echo "  ç«¯å£: $(PORT)"
	@echo "  ç¯å¢ƒ: $(shell $(UV) run python -c "from src.core.config import settings; print(settings.ENVIRONMENT)")"
	@echo ""

# å¿«é€Ÿåˆ«å
s: start ## startçš„åˆ«å
m: migrate ## migrateçš„åˆ«å
t: test ## testçš„åˆ«å
l: lint ## lintçš„åˆ«å
c: clean ## cleançš„åˆ«å